<?php

namespace App\services\soma;

use App\services\BaseService;

/**
 * Class PackageService
 * @package App\services\soma
 *
 */
class PresentsService extends BaseService
{

    /**
     *
     * @return PackageService
     * @author renshuai  <renshuai@jperation.cn>
     */
    public static function getInstance()
    {
        return self::init(self::class);
    }


    public static function save_order($business, $inter_id){

    }


    public static function get_gift_received_users( $inter_id , $gift_id , $give_openid ,$orders = array() , $business = 'package'){
        $filter = array();
        $receiveUsersArr = array();

        $filter['openid_give'] = $give_openid;
        self::getInstance()->getCI()->load->model('soma/Gift_order_model');
        $giftOrderModel = self::getInstance()->getCI()->Gift_order_model;
        $giftOrderModel  = $giftOrderModel->load($gift_id);
        $receiveOrders= $giftOrderModel->get_receiver_list($inter_id, $gift_id, $filter );

        if(empty($orders)){
            $orders = $giftOrderModel->get_order_detail($business, $inter_id);
        }

        if(empty($orders))  return array();

        //数据格式整理
        $openids = array();
        if($orders['is_p2p'] == $giftOrderModel::GIFT_TYPE_P2P){      //对私
            $openids= !empty($orders['openid_received']) ? array( $orders['openid_received'] ) : array();
        }elseif($orders['is_p2p'] == $giftOrderModel::GIFT_TYPE_GROUP){  //群发
            foreach ($receiveOrders as $k=>$v){
                $openids[]= $v['openid'];
            }
        }

        self::getInstance()->getCI()->load->model('wx/Publics_model');
        $publicModel = self::getInstance()->getCI()->Publics_model;
        $openid_data= !empty($openids) ? $publicModel->get_fans_info_byIds($openids):array();
        $openid_hash= $giftOrderModel->array_to_hash($openid_data, 'nickname', 'openid');
        $headimg_hash= $giftOrderModel->array_to_hash($openid_data, 'headimgurl', 'openid');

        $receiveUserFiled = ['receiver_id','gift_id','inter_id','openid_give','hotel_id','total_qty','source',
            'remote_ip','status'
        ];

        foreach ($receiveOrders as $k=>$v){
            //填充openid昵称
            if( array_key_exists($v['openid'], $openid_hash ))
                $receiveOrders[$k]['openid_nickname']= $openid_hash[$v['openid']];
            if( array_key_exists($v['openid'], $headimg_hash ))
                $receiveOrders[$k]['openid_headimg']= $headimg_hash[$v['openid']];

            $receiveOrders[$k]['get_time'] = date("m-d H:i",strtotime($receiveOrders[$k]['get_time']));
            $receiveUser = new \App\libraries\Support\Collection($receiveOrders[$k]);
            $receiveUser  = $receiveUser->except($receiveUserFiled);
            $receiveUsersArr[] = $receiveUser->toArray();

        }

        return  $receiveUsersArr;

    }


}