<?php
use App\libraries\Iapi\FrontConst;
use App\services\soma\ScopeDiscountService;

defined('BASEPATH') OR exit('No direct script access allowed');

/**
 * Class Package
 *
 * @property Product_package_model $productPackageModel
 */
class Package extends MY_Front_Soma_Iapi
{
    /**
     * @SWG\Get(
     *     path="/package/info",
     *     summary="Find package by ID",
     *     description="Returns a single package",
     *     operationId="get_info",
     *     produces={"application/json"},
     *     @SWG\Parameter(
     *         description="ID of package to return",
     *         in="query",
     *         name="pid",
     *         required=true,
     *         type="integer",
     *         format="int32"
     *     ),
     *     @SWG\Response(
     *         response=200,
     *         description="successful operation",
     *         @SWG\Schema(
     *              type="object",
     *              @SWG\Property(
     *                  property="product_id",
     *                  type="integer",
     *                  format="int32",
     *              ),
     *              @SWG\Property(
     *                  property="name",
     *                  type="string"
     *              ),
     *              @SWG\Property(
     *                  property="list",
     *                  type="array",
     *                  @SWG\Items(
     *                      type="object",
     *                      @SWG\Property(
     *                          property="id",
     *                          type="integer"
     *                      ),
     *                      @SWG\Property(
     *                          property="name",
     *                          type="string"
     *                      )
     *                  ),
     *              )
     *         )
     *     ),
     *     @SWG\Response(
     *         response="400",
     *         description="Invalid pid supplied"
     *     ),
     *     @SWG\Response(
     *         response="404",
     *         description="Package not found"
     *     ),
     * )
     */
    public function get_info()
    {
        $data = [];

        $productId = $this->input->get('pid');

        if (empty($productId)) {
            show_error('Invalid pid supplied', 400);
        }

        $this->load->model('soma/product_package_model', 'productPackageModel');
        $productDetail = $this->productPackageModel->getByID($productId, $this->inter_id);

        if (empty($productDetail)) {
            show_404();
        }

        $productDetail['gallery'] = $this->productPackageModel->get_gallery_front($productId, $this->inter_id);

        $bType = $this->input->get('bType');
        if ($bType) {
            $this->session->set_userdata('b_type', $bType);
        }

        $products = array($productDetail);
        ScopeDiscountService::getInstance()->appendScopeDiscount($products, $this->current_inter_id, $this->openid, false);
        $productDetail = $products[0];
        $this->productPackageModel->appendEnInfo($productDetail);

        //todo 秒杀
        //todo 拼团
        
        $ticketId = $this->session->tkid ? $this->session->tkid : '';
        $isOff = $this->productPackageModel->isOff($productDetail);

        $data['product'] = $productDetail;
        $data['public'] = $this->public;

        $this->out_put_msg(FrontConst::OPER_STATUS_SUCCESS, '', $data);
    }

    //todo 获取对规格数据
    //todo 查询自身分销员信息

    /**
     * @SWG\Get(
     *     path="/package/list",
     *     description="Returns packages",
     *     operationId="get_list",
     *     produces={"application/json"},
     *     @SWG\Response(
     *         response=200,
     *         description="successful operation",
     *         @SWG\Schema(
     *           type="array",
     *           @SWG\Items(
     *              type="object",
     *              @SWG\Property(
     *                  property="id",
     *                  type="integer"
     *               ),
     *               @SWG\Property(
     *                   property="name",
     *                   type="string"
     *               )
     *           ),
     *         )
     *     ),
     *     @SWG\Response(
     *         response="400",
     *         description="Invalid ID supplied"
     *     ),
     *     @SWG\Response(
     *         response="404",
     *         description="Package not found"
     *     )
     * )
     */
    public function get_list()
    {

    }

}