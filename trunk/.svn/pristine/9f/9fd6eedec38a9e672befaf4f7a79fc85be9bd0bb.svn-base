<?php

class Luopan extends MY_Controller{
	
	public function __construct(){
		parent::__construct();
	}
	
	public function order_detail(){
		set_time_limit(0);
		$json='[{"inter_id":"a452223043","openid":"oPDB9jrbchOsfSO5jSlNam5nrSr0","hotel_id":"646","name":"\u6587\u6ce2","tel":"18692256322","startdate":"20170808","enddate":"20170809","orderid":"r0150216030894663","web_orderid":"O1708081045085096834S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=www.ldmlfs.com&sob.password=20120525&sob.hotelgroup_id=376\"}","hotel_web_id":"cnhnldmlls"}, {"inter_id":"a452223043","openid":"oPDB9jrbchOsfSO5jSlNam5nrSr0","hotel_id":"646","name":"\u6587\u6ce2","tel":"18692256322","startdate":"20170808","enddate":"20170809","orderid":"r0150216037238182","web_orderid":"O1708081046126893794S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=www.ldmlfs.com&sob.password=20120525&sob.hotelgroup_id=376\"}","hotel_web_id":"cnhnldmlls"}, {"inter_id":"a452223043","openid":"oPDB9jrbchOsfSO5jSlNam5nrSr0","hotel_id":"646","name":"\u6587\u6ce2","tel":"18692256322","startdate":"20170808","enddate":"20170809","orderid":"r0150216041608274","web_orderid":"O1708081046563680068S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=www.ldmlfs.com&sob.password=20120525&sob.hotelgroup_id=376\"}","hotel_web_id":"cnhnldmlls"}, {"inter_id":"a452223043","openid":"oPDB9jow1C3qOies32YraiF_p-AI","hotel_id":"646","name":"\u6768\u5efa\u6797","tel":"13517386299","startdate":"20170809","enddate":"20170810","orderid":"AI150229122223806","web_orderid":"O1708092307028796196S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=www.ldmlfs.com&sob.password=20120525&sob.hotelgroup_id=376\"}","hotel_web_id":"cnhnldmlls"}, {"inter_id":"a495437302","openid":"ohQg2wfdgcKQr4hzG1EJclT-lU4g","hotel_id":"5724","name":"\u97e6\u8587","tel":"18507720556","startdate":"20170809","enddate":"20170810","orderid":"4g150221951744719","web_orderid":"O1708090311579063998S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnufan"}, {"inter_id":"a495442905","openid":"oa6rpwOsVEkQEobyWukp9IeZtSbA","hotel_id":"5725","name":"\u5f90\u7ee7\u73ae","tel":"13916286331","startdate":"20170807","enddate":"20170809","orderid":"bA150206964388134","web_orderid":"O1708070934041504070S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwLj6_LxlPE74Bej9gfDjt6o","hotel_id":"5725","name":"\u6885\u6842\u82db","tel":"13755188359","startdate":"20170808","enddate":"20170809","orderid":"6o150209511789128","web_orderid":"O1708071638375390702S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwNQ7Y_dU8nxPM6smgEoOXL0","hotel_id":"5725","name":"\u5f20\u5efa\u5f3a","tel":"13877223338","startdate":"20170808","enddate":"20170809","orderid":"L0150212169790371","web_orderid":"O1708080001380233435S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwJkEsWZTP-SEbMkzxLo9zt4","hotel_id":"5725","name":"\u6731\u5baa\u5fe0","tel":"13916915631","startdate":"20170809","enddate":"20170810","orderid":"t4150214891136403","web_orderid":"O1708080735122894806S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwJ96Wl90krARB3TZ0hyE4xQ","hotel_id":"5725","name":"\u6881\u6d77","tel":"13877211535","startdate":"20170808","enddate":"20170809","orderid":"xQ150216726593859","web_orderid":"O1708081241060760180S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwNOlzTBRtzhhQAeNGL12-j4","hotel_id":"5725","name":"\u5510\u8f89","tel":"13557628609","startdate":"20170808","enddate":"20170809","orderid":"j4150216732576505","web_orderid":"O1708081242056953546S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwB-8TAX09Zy8wvRVs-5l7Ko","hotel_id":"5725","name":"\u718a\u6d9b","tel":"15278860007","startdate":"20170808","enddate":"20170809","orderid":"Ko150216799532113","web_orderid":"O1708081253158773766S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwCKAmCBrGOkmuBzVU19KisY","hotel_id":"5725","name":"\u59ec\u7f8e\u4f36","tel":"13650517183","startdate":"20170808","enddate":"20170809","orderid":"sY150216971853584","web_orderid":"O1708081321582981031S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwB-8TAX09Zy8wvRVs-5l7Ko","hotel_id":"5725","name":"\u718a\u6d9b","tel":"15278860007","startdate":"20170809","enddate":"20170810","orderid":"Ko150225266852144","web_orderid":"O1708091224287048837S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwJkEsWZTP-SEbMkzxLo9zt4","hotel_id":"5725","name":"\u8c22\u5e86\u9f99","tel":"18918855275","startdate":"20170809","enddate":"20170810","orderid":"t4150226414335903","web_orderid":"O1708091535436780154S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwEPyTFqbZyUec7mh-NddnM8","hotel_id":"5725","name":"\u9ec4\u7434","tel":"13977274680","startdate":"20170809","enddate":"20170810","orderid":"M8150228548648018","web_orderid":"O1708092131268290643S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxlzyy00"}, {"inter_id":"a495442905","openid":"oa6rpwEbZG94QLt_QTcVCEosUYio","hotel_id":"5726","name":"\u738b\u5b9a\u534e","tel":"13807834666","startdate":"20170804","enddate":"20170808","orderid":"io150167515384951","web_orderid":"O1708021959136517278S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnyoui"}, {"inter_id":"a495442905","openid":"oa6rpwPFUWfVygCPexdbj1So8tHI","hotel_id":"5726","name":"\u9646\u7434","tel":"13450798680","startdate":"20170807","enddate":"20170808","orderid":"HI150210614190026","web_orderid":"O1708071942219246445S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnyoui"}, {"inter_id":"a495442905","openid":"oa6rpwLmERCw_nPcDyiKcM4jV7K0","hotel_id":"5726","name":"\u91d1\u623f\u5361\u6d4b\u8bd5","tel":"13570586569","startdate":"20170808","enddate":"20170809","orderid":"K0150217493662975","web_orderid":"O1708081448570934908S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnyoui"}, {"inter_id":"a495442905","openid":"oa6rpwN0m_NQIho9A_3QxCxtxj9o","hotel_id":"5726","name":"\u91d1\u5b66","tel":"13117712222","startdate":"20170808","enddate":"20170809","orderid":"9o150219263164789","web_orderid":"O1708081943513574752S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnyoui"}, {"inter_id":"a495442905","openid":"oa6rpwM1dgeBGoxcoqh2sYig0oHA","hotel_id":"5726","name":"\u9a6c\u7a7a\u5348","tel":"15177110693","startdate":"20170808","enddate":"20170809","orderid":"HA150219630912300","web_orderid":"O1708082045095327785S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnyoui"}, {"inter_id":"a495442905","openid":"oa6rpwIqnlHm7dA_-AqWrSdDSs00","hotel_id":"5726","name":"\u738b\u5c0f\u9f99","tel":"15240766376","startdate":"20170808","enddate":"20170809","orderid":"00150219900267928","web_orderid":"O1708082130023961725S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxnnyoui"}, {"inter_id":"a495470684","openid":"ovqaZuOL2DlpD0bIzRGRiAJ1pM3k","hotel_id":"5728","name":"2","tel":"15878042833","startdate":"20170808","enddate":"20170809","orderid":"3k150217378654344","web_orderid":"O1708081429466352316S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuJB15Xw_a-JiX92u9byTPwM","hotel_id":"5728","name":"\u5415\u7434","tel":"18277594620","startdate":"20170808","enddate":"20170809","orderid":"wM150217763429981","web_orderid":"O1708081533551958854S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuBvbKjWqrr9RjrzeFu0IfUs","hotel_id":"5728","name":"\u90b9\u51e4\u8bd7","tel":"18377576302","startdate":"20170808","enddate":"20170809","orderid":"Us150219714010995","web_orderid":"O1708082059010362175S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuNn4EPXTzuNvddpfQCvmUbo","hotel_id":"5728","name":"\u59da\u7f8e\u8fde","tel":"13978520582","startdate":"20170808","enddate":"20170809","orderid":"bo150219872523611","web_orderid":"O1708082125260374633S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuG_zEpsbumJqUXLwgTYMDlQ","hotel_id":"5728","name":"\u6797\u7389\u5bb9","tel":"18319369178","startdate":"20170808","enddate":"20170809","orderid":"lQ150220202751470","web_orderid":"O1708082220279052735S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuH-zm3vRU9ExxLVUiX0rWao","hotel_id":"5728","name":"\u6881\u6d77\u9f99","tel":"15077773567","startdate":"20170809","enddate":"20170810","orderid":"ao150221012518439","web_orderid":"O1708090035254880949S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuG1-I6WpfBU8U1B9LbxWOXk","hotel_id":"5728","name":"\u51af\u6625\u65ed","tel":"13577574090","startdate":"20170808","enddate":"20170809","orderid":"Xk150221124756197","web_orderid":"O1708090054078492876S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}, {"inter_id":"a495470684","openid":"ovqaZuG_zEpsbumJqUXLwgTYMDlQ","hotel_id":"5728","name":"\u6797\u7389\u5bb9","tel":"18319369178","startdate":"20170809","enddate":"20170810","orderid":"lQ150223872822571","web_orderid":"O1708090832088740092S","pms_auth":"{\"url\":\"http:\\\/\\\/x.hotelwebs.cn:8900\\\/gateway\\\/\",\"url_auth\":\"sob.sob_code=889.hotelwebs.cn&sob.password=huaxiaweb&sob.hotelgroup_id=889\",\"currency_code\":\"CNY\",\"reserve_hour\":\"2400\",\"order_card_no\":1,\"multi_rooms\":1}","hotel_web_id":"cngxylshjz"}]';
		
		$order_list=json_decode($json,true);
		
		
		$this->load->helper('common');
		
		$this->load->model('hotel/pms/Luopan_hotel_model', 'pms');
		
		$sql='';
		foreach($order_list as $v){
			$pms_auth=json_decode($v['pms_auth'],true);
			$url = $pms_auth['url'] . 'get_order_detail?' . $pms_auth['url_auth'];
			
			$data = array (
				"room_order_id" => $v['web_orderid'],
				"mobile_or_email" => $v['tel']
			);
			$res = $this->pms->get_to ( $url, $data, $v['inter_id']);
			
			foreach($res['registers'] as $t){
				$web_start = date('Ymd', strtotime($t['check_in_date']));
				$web_end = date('Ymd', strtotime($t['check_out_date']));
				$web_end = $web_end == $web_start ? date('Ymd', strtotime('+ 1 day', strtotime($web_start))) : $web_end;
				
				$web_day_diff = get_room_night($web_start, $web_end, 'ceil');//至少有一个间夜
				
				if($web_day_diff>1)
				$sql.="update `iwide_hotel_order_items` set `startdate` = '".$web_start."', `enddate` = '".$web_end."' where `inter_id` = '".$v['inter_id']."' and `orderid` = '".$v['orderid']."' and webs_orderid = '".$t['id']."';\n";
			}
		}
		echo $sql;
	}
	
	function pms_enum($type,$key=null) {
		$arr=[];
		switch ($type) {
			case 'status' :
				$arr= array (
					'0' => 1,
					'1' => 2,
					'2' => 3,
					'3' => 5,
					'4' => 8
				);
				break;
			case 'func_name':
				$arr=[
					'search_hotel_rates' => '获取房价',
					'create_order'=>'新增订单',
					'get_order_detail'=>'查询订单',
					'cancel_order'=>'取消订单',
					'deposit_order'=>'网络支付入账',
				];
				break;
		}
		
		if($key === null){
			return $arr;
		}
		return isset($arr[$key]) ? $arr[$key] : null;
	}
	
	public function test_order(){
		$json='{"order":{"room_order_id":"O1708082134271737024S","hotel_id":"cnhnldmllg","hotel_name":"娄底涟钢店","currency_code":"","exchange_rate":1.0,"room_type_id":6985,"room_type_code":"流金岁月D","room_type_name":"流金岁月D","room_quantity":1,"adult_quantity":1,"child_quantity":0,"check_in_date":"2017-08-08","check_out_date":"2017-08-09","hour":0,"rate_code":"LIST","discount":0.0,"prepaid":0.0,"total_order_money":137.0,"contacter":"柳","email":"","mobile":"15197867613","phone":"15197867613","fax":"","note":"微信订单/铂金卡会员价。使用优惠券：20.00。","payment_mode_id":0,"arrive_info":"","reserve_hour":18,"guarantee_score":0.0,"order_status":2,"status_desc":"入住完毕","ip":"","biz_source_id":13,"created_at":"2017-08-08 21:34:27","total_score":0.0,"first_day_price":137.0,"room_nos":"9503","voucher_count":1},"order_guests":[],"addon_items":[],"registers":[{"id":"R1708080009232902L","hotel_id":"cnhnldmllg","hotel_name":"娄底涟钢店","room_no":"9503","floor_code":"05","building_code":"01","check_in_date":"2017-08-08","check_out_date":"2017-08-09","check_out_time":"2017-08-09 09:53:35","guest_names":"柳志军","room_rate":137.0,"total_debit":0.0,"total_credit":0.0}]}';
		$res=json_decode($json,true);
		$new_status = null;
		
		$status_arr = $this->pms_enum ( 'status' );
		$new_status = $status_arr [$res ['order'] ['order_status']];
		
		if(!empty($res['registers'])){
			is_array(current($res['registers'])) or $res['registers']=[$res['registers']];
			//本地订单列表是否已更新过入住ID
			$local_items = [];
			$local_noitem = [];
			
			$i = 0;
			foreach($res['registers'] as $v){
				$updata = [];
				/*if(isset($local_items[$v['id']])){
					$od = $local_items[$v['id']];
				}else{
					//不存在本地订单中
					$od = $local_noitem[$i];
					//有子订单号时才执行更新操作
					if($v['id'])
						$this->db->where(['id' => (int)$od['sub_id']])->update('hotel_order_items', ['webs_orderid' => $v['id']]);

//							$updata['webs_orderid'] = $v['FolioID'];
					$i++;
				}*/
				$od=[
					'sub_id'=>1895437,
					'startdate'=>'20170808',
					'enddate'=>'20170809',
					'iprice'=>'137.00',
					'istatus'=>1
				];
				//存在istatus是，酒店取消
				if(!empty($v['istatus'])&&$v['istatus']==4){
					$istatus=$v['istatus'];
				}else{
					$istatus=$new_status;
					
					//判断日期，价格
					//PMS上的入住，离店时间
					$web_start = date('Ymd', strtotime($v['check_in_date']));
					$web_end = date('Ymd', strtotime($v['check_out_date']));
					$web_end = $web_end == $web_start ? date('Ymd', strtotime('+ 1 day', strtotime($web_start))) : $web_end;
					
					//判断实际入住时间，订单记录的入住时间
					$ori_day_diff = get_room_night($od['startdate'], $od['enddate'], 'ceil', $od);//至少有一个间夜
					$web_day_diff = get_room_night($web_start, $web_end, 'ceil');//至少有一个间夜
					$day_diff = $web_day_diff - $ori_day_diff;
					
					$updata['startdate'] = $web_start;
					$updata['enddate'] = $web_end;
					if($day_diff != 0 || $web_start != $od['startdate'] || $web_end != $od['enddate']){
						$updata['no_check_date'] = 1;
					}
					
					$new_price=$v['room_rate'];
					if($new_price >= 0 && $new_price != $od['iprice']){
						$updata['no_check_date'] = 1;
						$updata['new_price'] = $new_price;
					}
				}
				
				if($istatus != $od['istatus']&&$istatus!=-1){
					$updata['istatus'] = $istatus;
				}
				
				if(!empty ($updata)){
					print_r($updata);
				}
				
			}
			
		}else{
			if ($new_status != $list ['status']) {
				$this->db->where ( array (
					'inter_id' => $list ['inter_id'],
					'orderid' => $list ['orderid']
				) );
				$this->db->update ( 'hotel_orders', array (
					'status' => $new_status
				) );
				$this->Order_model->handle_order ( $inter_id, $list ['orderid'], $new_status, $list ['openid'] );
			}
		}
	}
}