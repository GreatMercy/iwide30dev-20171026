<?php
namespace App\services\soma;

use App\libraries\Http;
use App\libraries\Support\Log;
use App\services\BaseService;
use App\services\Result;
use EasyWeChat\Foundation\Application;

/**
 *
 * 以后使用命名空间！！！
 *
 *
 * Class WxService
 * @package App\services\soma
 * @author renshuai  <renshuai@mofly.cn>
 *
 * @date 2017-06-21
 */
class WxService extends BaseService
{
    /**
     * 秒杀订阅关注
     */
    const QR_CODE_KILLSEC_SUBSCRIBE = '1234321';

    /**
     * 支付成功关注
     */
    const QR_CODE_PAY_SUCCESS_SUBSCRIBE = '1235321';

    /**
     * 获取服务实例方法
     * @return WxService
     */
    public static function getInstance()
    {
        return self::init(self::class);
    }

    /**
     * for test
     *
     * @return Application
     * @author renshuai  <renshuai@mofly.cn>
     */
    public function getApp()
    {
        $info = $this->getCI()->public_info;
        $config = [
            'debug' => true,
            'app_id'  => $info['app_id'],
            'secret'  => $info['app_secret'],
            'token'   => $info['token'],
            'aes_key' => $info['aes_key'],
            'log' => [
                'level'      => 'debug',
                'permission' => 0777,
                'file'       => APPPATH . 'logs/soma/easywechat.log',
            ],
            'guzzle' => [
                'timeout' => 3.0,
            ],
        ];

        if (ENVIRONMENT === 'production') {
            $config['debug'] = false;
            $config['log']['level'] = 'info';
        }

        $app = new Application($config);

        $this->getCI()->load->model ('wx/access_token_model');
        $access_token = $this->getCI()->access_token_model->get_access_token($info['inter_id'], true);

        $currentTime = time();
        if ($access_token['expire'] > $currentTime  && $access_token['expire'] - $currentTime > 1500 ) {
            $app->access_token->setToken($access_token['access_token'], $access_token['expire'] - time());
        } else {
            $access_token = $this->getCI()->access_token_model->reflash_access_token($info['inter_id'], true);
            $app->access_token->setToken($access_token['ticket'], $access_token['expire_in'] - time());
        }

        return $app;
    }

    /**
     * 获取一个二维码
     *
     * @param int $id
     * @return Result|\EasyWeChat\Support\Collection
     * @author renshuai  <renshuai@mofly.cn>
     */
    public function getQrcode($id)
    {
        $result = new Result();
        $redis = $this->getCI()->get_redis_instance();
        if (empty($redis)) {
            $result->setMessage('系统错误');
            return $result;
        }

        $interID = $this->getCI()->inter_id;
        $key = "QRCODE_FOREVE_{$interID}_{$id}";
        $url = $redis->get($key);

        if (empty($url)){
            $app = $this->getApp();

            $qrResult = $app->qrcode->forever($id);
            $ticket = $qrResult->ticket;
            $url = $app->qrcode->url($ticket);

            $redis->set($key, $url);
            $redis->expire($key, 3600 * 24 * 100);

        }

        $result->setStatus(Result::STATUS_OK);
        $result->setData($url);
        return $result;
    }


    /**
     * @param int $id
     * @param string $url
     * @return Result
     * @author zhangyi  <zhangyi@mofly.cn>
     */
    public function getSignUpdateCode($inter_id,$url){

        $result = new Result();

        if($inter_id){
            $this->getCI()->load->helper('common');
            $this->getCI()->load->model('wx/publics_model', 'publics');
            $this->getCI()->load->model('wx/access_token_model');
            $jsapiTicket = $this->getCI()->access_token_model->get_api_ticket( $inter_id );
            //$jsapiTicket = $this->access_token_model->get_api_ticket($this->session->userdata('inter_id'), $this->openid);

            $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off'
                || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            if(!$url)
                $url = "$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";

            $timestamp = time();
            $nonceStr = createNonceStr();
            $public = $this->getCI()->publics->get_public_by_id( $inter_id );

            // 这里参数的顺序要按照 key 值 ASCII 码升序排序
            $string = "jsapi_ticket=$jsapiTicket&noncestr=$nonceStr&timestamp=$timestamp&url=$url";
            $signature = sha1($string);
            $signPackage = array(
                "appId"     => $public['app_id'],
                "nonceStr"  => $nonceStr,
                "timestamp" => $timestamp,
                "url"       => $url,
                "signature" => $signature,
                "rawString" => $string
            );

            return $signPackage;

        }
    }


    public function subscribemsg($redirectUrl)
    {
        $info = $this->getCI()->public_info;
        $templageID = 'ViwYokCgkwdfmB4kgnw8rk5bXZv9hpJWvbMm5Epk7rg';
        $appID = $info['app_id'];

        $redirectUrl = urlencode($redirectUrl);
        $url = "https://mp.weixin.qq.com/mp/subscribemsg?action=get_confirm&appid={$appID}&scene=4200&template_id={$templageID}&redirect_url={$redirectUrl}&reserved=help#wechat_redirect";

        return $url;
    }

    public function sendMsg(Array $arr)
    {
        $arr = json_decode('{"openid":"o9VbtwwUedrHzhXFSfegtSFMIKtU","template_id":"ViwYokCgkwdfmB4kgnw8rk5bXZv9hpJWvbMm5Epk7rg","action":"confirm","reserved":"help","scene":"4200","title":"title","data":{"value":"data","color":"#173177"}}', true);

Log::debug('sendMsg', $arr);
        $this->getCI()->load->model('wx/access_token_model');
        $interID = 'a450089706';
//        $access_token = $this->getCI()->access_token_model->get_access_token($interID, true);
//        $token = $access_token['access_token'];
        $token = 'Vjg4YIonfh7wcW3DdTk0LaBYdXSNDCPhHyqUp5uHOOkRXb4BsM2esHjIL1zJ3zqKBG2BfDskicjMLIrm3bc6xpuZACLSyeDz9WCvNioEXeiQ6fP09WWwVgsKOzSzZiMmKNMeAHAEHG';
        $api = "https://api.weixin.qq.com/cgi-bin/message/template/subscribe?access_token={$token}";

Log::debug('sendMsg', [$api]);

        $client = new Http();
        $requestData = [
            'touser' => $arr['openid'],
            'template_id' => $arr['template_id'],
            'scene' => $arr['scene'],
            'title' => $arr['title'],
            'data' => $arr['data']
        ];
        $result = $client->json($api, $requestData, 256, ['access_token' => $token]);
        $data = $client->parseJSON($result);

Log::debug('sendMsg 2', $data);

        $result = $client->post($api, $requestData);
        $data = $client->parseJSON($result);
Log::debug('sendMsg 3', $data);
        return $data;

    }

}