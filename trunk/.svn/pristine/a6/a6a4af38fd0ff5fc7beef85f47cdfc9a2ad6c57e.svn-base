<?php
use App\services\Result;
use App\libraries\Iapi\BaseConst;
use App\services\soma\ExpressService;

/**
 * Class Express
 * @author renshuai  <renshuai@mofly.cn>
 *
 * @property Customer_address_model $customerAddressModel
 */
class Express extends MY_Front_Soma_Iapi
{


    /**
     * @SWG\Get(
     *     tags={"express"},
     *     path="/express/tree",
     *     summary="获取区域列表",
     *     description="获取区域列表",
     *     operationId="get_tree",
     *     produces={"application/json"},
     *     @SWG\Response(
     *         response="200",
     *         description="successful operation",
     *         @SWG\Schema(
     *              type="object",
     *              @SWG\Property(
     *                  property="data",
     *                  description="区域列表",
     *                  type="object",
     *                  @SWG\Items(ref="#/definitions/SomaCustomerAddress")
     *              )
     *         )
     *     )
     * )
     */
    public function get_tree()
    {
        $result = ExpressService::getInstance()->regionTree();
        $this->json(BaseConst::OPER_STATUS_SUCCESS, '', $result->getData());
    }


    /**
     * @SWG\Post(
     *     tags={"express"},
     *     path="/express/save",
     *     summary="保存（增加、修改）地址数据",
     *     description="保存（增加、修改）地址数据",
     *     operationId="get_save",
     *     produces={"application/json"},
     *     @SWG\Parameter(
     *         description="地址id。值为空：增加；值不为空且找到该条记录：修改",
     *         in="query",
     *         name="address_id",
     *         required=false,
     *         type="integer",
     *         format="int32",
     *     ),
     *     @SWG\Parameter(
     *         description="省id",
     *         in="query",
     *         name="province_id",
     *         required=true,
     *         type="integer",
     *         format="int32",
     *     ),
     *     @SWG\Parameter(
     *         description="市id",
     *         in="query",
     *         name="city_id",
     *         required=true,
     *         type="integer",
     *         format="int32",
     *     ),
     *     @SWG\Parameter(
     *         description="区id",
     *         in="query",
     *         name="region_id",
     *         required=true,
     *         type="integer",
     *         format="int32",
     *     ),
     *     @SWG\Parameter(
     *         description="详细地址",
     *         in="query",
     *         name="address",
     *         required=true,
     *         type="string",
     *     ),
     *     @SWG\Parameter(
     *         description="联系人",
     *         in="query",
     *         name="contact",
     *         required=true,
     *         type="string",
     *     ),
     *    @SWG\Parameter(
     *         description="phone",
     *         in="query",
     *         name="contact",
     *         required=true,
     *         type="string",
     *     ),
     *     @SWG\Response(
     *         response="200",
     *         description="successful operation",
     *         @SWG\Schema(
     *              type="object",
     *                  @SWG\Property(
     *                      property="address_id",
     *                      description="保存地址id",
     *                      type="integer",
     *                  )
     *         )
     *     ),
     *     @SWG\Response(
     *         response="400",
     *         description="缺少必要参数或保存失败"
     *     )
     * )
     */
    public function get_save(){

        $this->load->library('form_validation');

        $rules = array(
            'province' => array(
                'field' => 'province',
                'rules' => 'required'
            ),
            'city' => array(
                'field' => 'city',
                'rules' => 'required'
            ),
            'address' => array(
                'field' => 'address',
                'rules' => 'required'
            ),
            'phone' => array(
                'field' => 'phone',
                'rules' => 'required',
            ),
            'contact' => array(
                'field' => 'contact',
                'rules' => 'required'
            ),
        );

        $this->form_validation->set_data($this->input->post());
        $this->form_validation->set_rules($rules);
        if($this->form_validation->run() === false) {
            $result['message'] = $this->form_validation->error_string();
            show_error('Invalid pid supplied', 400);
            return;
        }

        $item = [
            'openid' => $this->openid,
            'inter_id' => $this->inter_id,
            'address_id' => $this->input->post('address_id'),
            'province' => $this->input->post('province'),
            'city' => $this->input->post('city'),
            'region' => $this->input->post('region'),
            'address' => $this->input->post('address'),
            'phone' => $this->input->post('phone'),
            'contact' => $this->input->post('contact'),
        ];

        $returnData = ExpressService::getInstance()->saveRegion($item);
        if($returnData){
            $this->json(BaseConst::OPER_STATUS_SUCCESS, '保存成功', ['address_id' => $returnData]);
            return;
        }

        show_error('保存失败', 400);  //todo
    }

}