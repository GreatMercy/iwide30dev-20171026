<?php

namespace App\services\soma;

use App\services\BaseService;

/**
 * Class PackageService
 * @package App\services\soma
 *
 */
class PackageService extends BaseService
{

    /**
     *
     * @return PackageService
     * @author renshuai  <renshuai@jperation.cn>
     */
    public static function getInstance()
    {
        return self::init(self::class);
    }


    /**
     * 获取套票列表
     * @param array $params
     * @return array
     * @author liguanglong  <liguanglong@mofly.cn>
     */
    public function index($params = []){

        //查看权限
        $inter_id = $this->getCI()->session->get_admin_inter_id();
        if($inter_id != FULL_ACCESS){
            $params['inter_id'] = $inter_id ? $inter_id : 'deny';
        }

        $this->getCI()->load->model('soma/product_package_model', 'productPackageModel');
        $productPackageModel = $this->getCI()->productPackageModel;
        return $productPackageModel->getProductsList($params);
    }


    /**
     * 获取套票分类
     * @param $inter_id
     * @return mixed
     * @author liguanglong  <liguanglong@mofly.cn>
     */
    public function getCatalog($inter_id){

        $this->getCI()->load->model('soma/category_package_model', 'CategoryPackageModel');
        $categoryPackageModel = $this->getCI()->CategoryPackageModel;
        return $categoryPackageModel->getCatalog($inter_id);
    }


    /**
     * 判断当前用户是否为分销员或者是泛分销
     * @param $inter_id
     * @param $openid
     * @return array
     * @author luguihong  <luguihong@jperation.com>
     */
    public function getUserSalerOrFansaler($inter_id, $openid)
    {
        $this->getCI()->load->library('Soma/Api_idistribute');
        $staff = $this->getCI()->api_idistribute->get_saler_info($inter_id, $openid);
        if($staff)
        {
            //判断是分销员还是泛分销 $staff['typ'] ＝ 'STAFF'(分销员), 'FANS'(泛分销)
            $saler_type     = isset($staff['typ']) && ! empty($staff['typ']) ? $staff['typ'] : '';
            $saler_id       = isset($staff['info']['saler']) && ! empty($staff['info']['saler']) ? $staff['info']['saler'] : 0;
            if ($saler_id && $saler_type)
            {
                //分销员名称
                $saler_name     = isset($staff['info']['name']) && ! empty($staff['info']['name']) ? $staff['info']['name'] : '';

                //返回分销员信息
                $salesArr = array(
                    'saler_id'      => $saler_id,
                    'saler_type'    => $saler_type,
                    'saler_name'    => $saler_name,
                );

                return $salesArr;
            }
        }

        return array();
    }


    /**
     * 处理分销号和泛分销号
     * @author luguihong  <luguihong@jperation.com>
     */
    /*public function handleDistribute()
    {
        $salerId        = $this->input->get('saler');
        $fansSalerId    = $this->input->get('fans_saler');
        if( $salerId ) {
            //如果链接存在分销号，就不刷新链接的分销号，转发刷新，购买计算绩效
            $this->session->set_userdata( 'giveDistribute'.$this->inter_id.$this->openid, $salerId );
        } else {
            //需要跳转
            $url =  \App\libraries\Support\Url::current();

            //如果链接不存在分销号，判断是否为分销员
            $staff = $this->getUserSalerOrFansaler();
            if ($staff)
            {
                $saler_type = $staff['saler_type'];
                $saler_id   = $staff['saler_id'];
                if ($saler_id && $saler_type)
                {
                    if ($saler_type == 'STAFF')
                    {
                        $this->session->set_userdata( 'isSaler'.$this->inter_id.$this->openid, json_encode($staff) );

                        //是分销员，跳转链接，带上自己的分销号，购买计算绩效
                        $url .= "&saler={$saler_id}";
                        header("Location: $url");
                        die;
                    } elseif ($saler_type == 'FANS') {
                        //是泛分销员，判断页面是否带有泛分销号
                        if( $fansSalerId )
                        {
                            //带泛分销号，是否为自己的泛分销号
                            if( $fansSalerId == $saler_id )
                            {
                                //是自己的泛分销号，购买不赠送绩效
                                $this->session->set_userdata( 'giveDistribute'.$this->inter_id.$this->openid, '' );
                            } else {
                                //不是自己的泛分销号，购买后计算绩效给泛分销号员
                                $this->session->set_userdata( 'giveDistribute'.$this->inter_id.$this->openid, $fansSalerId );
                            }
                        } else {
                            //不带泛分销号，静默授权泛分销号，跳转链接带上泛分销号，购买不赠送绩效
                            //静默授权已经在父类进行，无需在这里操作
                            $url .= "&fans_saler={$saler_id}";
                            header("Location: $url");
                            die;
                        }
                    }
                }
            }
        }
    }*/

}