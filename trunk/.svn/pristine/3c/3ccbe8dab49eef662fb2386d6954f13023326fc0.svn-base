<template>
  <div class="jfk-pages jfk-pages__send-gift">
    <div class="jfk-pages__theme "></div>
    <div class="title jfk-ta-c font-size--30">赠送内容</div>
    <div class="jfk-pl-30 jfk-pr-30">

      <div class="goods-info  jfk-image__lazy--preload  jfk-image__lazy--3-3 jfk-image__lazy--background-image">
        <a href="javascript:void(0)">

          <img v-if="giftInfo.face_img" :src="giftInfo.face_img">

          <div class="goods-info-mask"></div>

          <div class="goods-info-content">

            <div class="goods-info-desc jfk-flex is-align-middle">

              <div class="font-size--30 goods-info-desc__packname" v-if="giftInfo.name" v-html="giftInfo.name"></div>

              <div class="goods-info-desc__price" v-if="giftInfo.residue === 0 || giftInfo.residue === 1">
                <span class="jfk-price font-size--54">
                  <i class="jfk-font-number jfk-price__currency">¥</i>
                  <i class="jfk-font-number jfk-price__number" v-html="giftInfo.price_package"></i>
                </span>
                <span class="font-size--24 jfk-d-ib goods-info-desc__price-number">1份</span>
              </div>

              <div class="goods-info-desc__goods_number" v-if="giftInfo.residue > 1">
                <span class="goods-info-desc__title font-size--24">送出</span>
                <span class="goods-info-desc__number font-size--24"
                      v-if="giftInfo.send_out_number"
                      v-html="giftInfo.send_out_number + '份'"></span>
                <span class="goods-info-desc__line jfk-d-ib"></span>
                <span class="goods-info-desc__title font-size--24">剩余</span>
                <span class="goods-info-desc__number font-size--24" v-if="giftInfo.qty"
                      v-html="giftInfo.qty + '份'"></span>
              </div>

            </div>
          </div>
        </a>
      </div>

      <ul class="gift-info">

        <li class="gift-info__item jfk-flex is-align-middle" v-if="giftInfo.residue > 1">
          <div class="gift-info-title font-size--28">收礼人数</div>
          <div class="gift-info-content jfk-ta-r">
            <div class="gift-info-content__number-input jfk-d-ib">
              <div class="reduce font-size--28 jfk-ta-c jfk-d-ib"
                   @click="changeGiftNumber('giftsPersonNumber', 'reduce')">-
              </div>
              <div class="number font-size--28 jfk-ta-c jfk-d-ib" v-text="giftsPersonNumber"></div>
              <div class="add font-size--28 jfk-ta-c jfk-d-ib" @click="changeGiftNumber('giftsPersonNumber', 'add')">+
              </div>
            </div>
            <div class="gift-info-content__unit font-size--32 jfk-d-ib">人</div>
          </div>
        </li>

        <li class="gift-info__item jfk-flex is-align-middle" v-if="giftInfo.residue > 1">
          <div class="gift-info-title font-size--28">每人收到</div>
          <div class="gift-info-content jfk-ta-r">
            <div class="gift-info-content__number-input jfk-d-ib">
              <div class="reduce font-size--28 jfk-ta-c jfk-d-ib"
                   @click="changeGiftNumber('giftsAverageNumber', 'reduce')">-
              </div>
              <div class="number font-size--28 jfk-ta-c jfk-d-ib" v-text="giftsAverageNumber"></div>
              <div class="add font-size--28 jfk-ta-c jfk-d-ib" @click="changeGiftNumber('giftsAverageNumber', 'add')">
                +
              </div>
            </div>
            <div class="gift-info-content__unit font-size--32 jfk-d-ib">份</div>
          </div>
        </li>

        <li class="gift-info__item jfk-flex is-align-middle" @click="choiceTheme">
          <div class="gift-info-title font-size--28">礼包主题</div>
          <div class="gift-info-theme gift-info-theme__arrow font-size--30">
            <span v-if="giftCurrentTheme.id" v-html="giftCurrentTheme.name"></span>
          </div>
        </li>

        <li class="gift-info__item jfk-flex is-align-middle">
          <input type="text" class="gift-info-wish font-size--30" placeholder="请输入您对祝福语" v-model="wish">
        </li>

      </ul>

      <div class="button-box">
        <a href="javascript:void(0);" class="jfk-button jfk-button--default" @click="give">确定赠送</a>
      </div>

      <a href="javascript:void(0);" class="jfk-ta-c font-size--28 gift-put-order" @click="putOrder">
        暂不处理，放至订单中心
      </a>

    </div>

  </div>
</template>
<script>
  import { JfkMessageBox } from 'jfk-ui'
  import { mapActions, mapGetters } from 'vuex'
  import { postPresentsSendOut } from '@/service/http'
  export default {
    created () {
      this.getGiftInfo()
    },
    computed: {
      ...mapGetters([
        'giftInfo',
        'giftCurrentTheme'
      ])
    },
    data () {
      return {
        // 祝福语
        wish: '送您一份礼物',
        giftsPersonNumber: 1, // 收礼的人数
        giftsAverageNumber: 1 // 每人多少盒
      }
    },
    methods: {
      ...mapActions([
        'getGiftInfo'
      ]),
      /**
       * 检测是否超出剩余的数量
       * @return {Number} 0 表示超出了数量 1 表示没有超出数量 2 表示到了最少的数量
       */
      checkGiftNumber () {
        const total = this.giftsPersonNumber * this.giftsAverageNumber
        if (total >= 1) {
          return total > this.giftInfo['residue'] ? 0 : 1
        } else {
          return 2
        }
      },
      modifyGiftNumber (number, bol) {
        if (bol) {
          this[number] += 1
        } else {
          this[number] -= 1
        }
      },
      /**
       * 修改礼物的数量
       * @param {String} operation {'add': '增加', 'reduce': '减少'}
       * @param {String} type {'giftsPersonNumber': '收礼的人数', 'giftsAverageNumber': '每人多少盒'}
       */
      changeGiftNumber (operation, type) {
        let bol = type === 'add'
        this.modifyGiftNumber(operation, bol)
        const result = this.checkGiftNumber()
        if (result === 0) {
          this.modifyGiftNumber(operation, !bol)
          this.$jfkToast('礼品总数不足')
        } else if (result === 2) {
          this.modifyGiftNumber(operation, !bol)
        }
      },
      // 选择主题
      choiceTheme () {
        this.$router.push({path: '/themes'})
      },
      // 放进订单中心
      putOrder () {
        console.log('放进订单中心')
      },
      // 确定赠送
      give () {
        // 判断是否选择主题
        if (String(this.giftCurrentTheme['id']).trim().length === 0) {
          this.$jfkToast('请选择礼包主题')
          return false
        }
        // 判断是否输入祝福语
        if (this.wish.length === 0) {
          this.$jfkToast('请输入您对祝福语')
          return false
        }
        // 提示的文案
        let msg = ''
        // 确认赠送提交参数
        let parameter = {
          // 祝福语
          'msg': this.wish,
          // 主题的id
          'tid': this.giftCurrentTheme['id'],
          // 收礼人数
          'count_give': this.giftsPersonNumber,
          // 发出礼盒数，每人多少盒
          'per_give': this.giftsAverageNumber
        }
        // 确定赠送
        if (this.giftInfo['residue'] > 1) {
          msg = `${this.giftInfo['residue']}份月饼将被${this.giftsPersonNumber}人领取，每人${this.giftsAverageNumber}份，超过24未领取将退回`
        } else if (this.giftInfo['residue'] === 0 || this.giftInfo['residue'] === 1) {
          msg = `1份月饼将被1人领取，超过24未领取将退回`
        }
        // 确认提交
        JfkMessageBox({
          title: '提示',
          message: msg,
          showConfirmButton: true,
          showCancelButton: true,
          confirmButtonText: '确定',
          cancelButtonText: '重新填写'
        }).then((res) => {
          if (res === 'confirm') {
            postPresentsSendOut(parameter)
          }
        })
      }
    }
  }
</script>
