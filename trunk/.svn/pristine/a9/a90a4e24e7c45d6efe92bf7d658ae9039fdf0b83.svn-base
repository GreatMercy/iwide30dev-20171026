<template>
  <div class="jfk-pages">
    <div class="jfk-pages__theme" v-if="!theme">
      <div class="jfk-image__lazy--preload  jfk-image__lazy--3-3 jfk-image__lazy--background-image"></div>
    </div>

    <div class="jfk-pages__gift" v-if="theme" v-show="boxShow">
      <div class="gift-box">
        <div class="gift-box-envelope">
          <div class="gift-box-wish jfk-ta-c font-size--36" v-html="name + '送你一份礼物'"></div>
          <div class="gift-box-content"></div>
          <div class="gift-box-bg"></div>
          <div class="gift-box-btn jfk-ta-c font-size--34" @click="openGift">打开礼盒</div>
        </div>
      </div>
    </div>

    <gift-detail :info="goodsDetail" :theme="theme" v-if="theme" v-show="detailShow"></gift-detail>
  </div>
</template>
<script>
  import { getPresentsValidateGiftOrder, postPresentsReceiveProcess } from '@/service/http'
  import { JfkMessageBox } from 'jfk-ui'
  import giftDetail from './module/gift_detail'
  const formatUrlParams = require('jfk-ui/lib/format-urlparams.js')
  let params = formatUrlParams.default(location.href)
  export default {
    name: 'gift',
    components: {
      giftDetail
    },
    data () {
      return {
        // 送礼人姓名
        name: '',
        // 商品详情
        goodsDetail: {},
        // 主题
        theme: '',
        // 礼盒显示
        boxShow: true,
        // 详情显示
        detailShow: true
      }
    },
    created () {
      let requestParams = {
        gid: params['gid'] || '',
        sign: params['sign'] || ''
      }
      getPresentsValidateGiftOrder(requestParams).then((res) => {
        const content = res['web_data']
        this.name = content['fans']['nickname']
        this.goodsDetail = content['item']
        this.goodsDetail['used'] = parseInt(content['item']['qty_origin']) - parseInt(content['item']['qty'])
        this.goodsDetail['wish'] = content['message']
        this.goodsDetail['link'] = content['order_list_url']
        this.theme = `gift-theme_${content['theme_keyword']}`
      })
    },
    methods: {
      openGift () {
        let requestParams = {
          gid: params['gid'] || '',
          sign: params['sign'] || '',
          bsn: params['bsn'] || ''
        }
        postPresentsReceiveProcess(requestParams).then((res) => {
          this.boxShow = false
          if (parseInt(res['web_data']['subscribe']) === 2) {
            JfkMessageBox({
              title: '提示',
              message: `您还没关注公众号，可能会影响礼品使用，先关注`,
              showConfirmButton: true,
              showCancelButton: true,
              confirmButtonText: '立即关注',
              cancelButtonText: '现在使用'
            })
          }
        }).catch(() => {
          this.boxShow = false
          this.detailShow = false
        })
      }
    }
  }
</script>
