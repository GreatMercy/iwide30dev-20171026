<?php
defined('BASEPATH') OR exit('No direct script access allowed');
/**
*	会员卡卡券
*	@author  Frandon
*	@copyright www.iwide.cn 
*	@version 4.0
*	@Email 489291589@qq.com
*/
class Cardcenter extends MY_Front_Member
{   private $initTime;
    private $endt;

    private $show_openid;
    private $show_inter_id;

    public function __construct()
    {
        $this->initTime = microtime(true);
        parent::__construct();
        $this->endt = microtime(true);

        $sem = $this->input->get('f');
        if($sem) $sem = base64_decode($sem);
        $segment_arr = explode('***', $sem);
        if (empty($segment_arr[0]) || empty($segment_arr[1]) || empty($segment_arr[2])){
            die('参数不全');
//            redirect ( site_url ( '/distribute/dis_ext/perror' ) . '?id=' . $this->input->get ( 'id' ) );
        }
        $this->load->model('wx/Publics_model','publics_model');
        $this->load->helper('qfglobal');
        //验证签名
        $m_inter_id = $segment_arr[0];
        $m_open_id  = $segment_arr[1];
        $decrypt    = $segment_arr[2];
        $m_public = $this->publics_model->get_public_by_id ($m_inter_id);
        $key = $m_public['app_secret'];
        $ec_data = $m_inter_id.$m_open_id;
        $encrypt = kecrypt($ec_data,$key);
        if($decrypt != $encrypt){
            die('验证不通过');
        }

        $this->show_inter_id = $m_inter_id;
        $this->show_openid =$m_open_id;

        $this->load->model ( 'distribute/openid_rel_model' );
        $flag = $this->openid_rel_model->new_rel ( array (
            'openid'     =>  $this->show_openid,
            'inter_id'   =>  $this->show_inter_id,
            'm_inter_id' => $this->session->userdata ( 'inter_id' ),
            'm_openid'   => $this->session->userdata ( $this->session->userdata ( 'inter_id' ) . 'openid' )
        )) ;
        if($flag){
            $this->member_template( $this->show_inter_id ); //模板设置
            $this->template_filed_name_set( $this->show_inter_id ); //自定义名字
        }else{
            log_message ( 'error', '公众号openid关联失败，FROM:' . $this->input->post ( 'inter_id' ) . '-' . $this->input->post ( 'openid' ) . ' TO:' . $this->input->post ( 'inter_id' ) );
        }
    }

    //会员卡券列表
	public function index(){

            //start show
            $inter_id = $this->show_inter_id;
            $open_id = $this->show_openid;
            $post_center_url = PMS_PATH_URL."member/center";
            $post_center_data =  array(
                'inter_id'=>$inter_id,
                'openid' =>$open_id,
            );
            //请求用户登录(默认)会员卡信息
            $member_info = $this->doCurlPostRequest( $post_center_url , $post_center_data )['data'];
            $member_info_id = isset($member_info['member_info_id'])?$member_info['member_info_id']:0;
            //获取会员卡券列表
            $do_curl = INTER_PATH_URL."membercard/getcardlist";
            $post_data = array(
                'inter_id'=>$inter_id,
                'member_info_id'=>$member_info_id,
                'openid'=>$open_id,
                'token'=>$this->_token,
                'range'=>'0,100',
                'template'=>$this->_template
            );

            $card_info = $this->doCurlPostRequest($do_curl,$post_data);
            $assign_data['all'] = array();
            $assign_data['usableCardLists'] = array();
            $assign_data['unusedCardLists'] = array();
            $assign_data['expiredCardLists'] = array();
            $phase2_arr=['zhouji','phase2','yasite'];
            if(!empty($this->_template) &&in_array($this->_template,$phase2_arr) ){
                if(isset($card_info['err']) && $card_info['err']=='0'){
                    $assign_data['all'] = isset($card_info['return']['all']['data'])?$card_info['return']['all']['data']:array();
                    $assign_data['usableCardLists'] = isset($card_info['return']['valids']['data'])?$card_info['return']['valids']['data']:array();
                    $assign_data['unusedCardLists'] = isset($card_info['return']['is_use']['data'])?$card_info['return']['is_use']['data']:array();
                    $assign_data['expiredCardLists'] = isset($card_info['return']['expired']['data'])?$card_info['return']['expired']['data']:array();
                }
            }else{
                $assign_data['cardlist'] = $card_info['data'];
            }

            $this->load->model('wx/Publics_model');
            $assign_data['public'] = $this->Publics_model->get_public_by_id($this->inter_id);
            $assign_data['next_id'] = isset($card_info['next_id']) ? $card_info['next_id'] : 0;
            $assign_data['inter_id'] = $inter_id;

            $assign_data['f_sign'] = $this->encrypt($inter_id,$open_id);
            $this->template_show('member',$this->_template,'card',$assign_data);

	}


    public function cardinfo(){
        $member_card_id = intval($this->input->get('member_card_id'));
        if(empty($member_card_id)){ //参数为空
            redirect(site_url('membervip/card').'?id='.$this->show_inter_id);
        }

        $this->load->model('membervip/front/Member_model','mem');
        $user = $this->mem->get_user_info($this->show_inter_id,$this->show_openid,'member_info_id,member_mode,is_login');
        if(empty($user)){ //找不到会员
            redirect(site_url('membervip/center').'?id='.$this->show_inter_id);
        }

        $post_cardinfo_data = array(
            'member_card_id' =>$member_card_id,
            'token'=>$this->_token,
            'openid'=>$this->show_openid,
            'inter_id'=>$this->show_inter_id,
        );

        $assign_data['inter_id'] = $this->show_inter_id;
        $assign_data['openid'] = $this->show_openid;
        $card_info = $this->doCurlPostRequest( INTER_PATH_URL."membercard/getinfo" , $post_cardinfo_data )['data'];

        if(!empty($card_info)){
            $card_info['use_way'] = '';
            switch ($card_info['is_online']){
                case '1':
                    $card_info['use_way'] = '在线使用';
                    if($card_info['is_given_by_friend']=='t') $card_info['use_way'] = '在线使用或赠送朋友';
                    break;
                case '2':
                    $card_info['use_way'] = '线下使用';
                    if($card_info['is_given_by_friend']=='t') $card_info['use_way'] = '线下使用或赠送朋友';
                    break;
                case '3':
                    $card_info['use_way'] = '可在线上和线下使用';
                    if($card_info['is_given_by_friend']=='t') $card_info['use_way'] = '可在线上和线下使用或赠送朋友';
                    break;
            }
        }
        //没有连接的话，默认跳转到酒店

        $assign_data['card_info'] = $card_info;

        $this->load->model('wx/access_token_model');
        $this->load->model('wx/Publics_model');
        $assign_data['public'] = $this->Publics_model->get_public_by_id($this->show_inter_id);

        /*获取微信JSSDK配置*/
        $assign_data['wx_config'] = $this->_get_sign_package($this->show_inter_id);
        $js_api_list = $menu_show_list = $menu_hide_list= '';
        $assign_data['base_api_list'] = array('hideMenuItems', 'showMenuItems', 'onMenuShareTimeline', 'onMenuShareAppMessage' );
        $assign_data['js_api_list'] = $assign_data['base_api_list'];

        foreach ($assign_data['js_api_list'] as $v){
            $js_api_list.= "'{$v}',";
        }

        $assign_data['js_api_list']= substr($js_api_list, 0, -1);

        //主动显示某些菜单
        $assign_data['js_menu_show']= array( 'menuItem:setFont', 'menuItem:share:appMessage', 'menuItem:share:timeline');
        $menu_show_list = '';
        foreach ($assign_data['js_menu_show'] as $v){
            $menu_show_list.= "'{$v}',";
        }
        $assign_data['js_menu_show']= substr($menu_show_list, 0, -1);

        //主动隐藏某些菜单
        $assign_data['js_menu_hide']= array('menuItem:share:appMessage','menuItem:share:timeline','menuItem:copyUrl','menuItem:share:email','menuItem:originPage','menuItem:favorite');
        $menu_hide_list = '';
        foreach ($assign_data['js_menu_hide'] as $v){
            $menu_hide_list.= "'{$v}',";
        }
        $assign_data['js_menu_hide']= substr($menu_hide_list, 0, -1);

        $assign_data['js_share_config']['title'] = isset($card_info['title'])?$card_info['title']:'';

        //加密参数
        $this->load->helper('qfglobal');
        $ec_data = $card_info['member_card_id'].'**'.$card_info['coupon_code'].'**'.$user['member_info_id'];
        $key = base64_encode($this->show_inter_id);
        $this->api_write_log($key,'card_key');
        $encrypt = encrypt($ec_data,$key);
        $encrypt = base64_encode($encrypt);
        $this->api_write_log($encrypt,'card_encrypt');
        $assign_data['js_share_config']['link'] = EA_const_url::inst()->get_url('*/*/receive',array('id'=>$this->show_inter_id,'s'=>$encrypt));
        $assign_data['js_share_config']['imgUrl'] = $card_info['logo_url'];
        $assign_data['js_share_config']['desc'] = "送你一张【".$card_info['title']."】帮你轻松享优惠";
        /*end*/
        //如果连接地址为空的话，则强行加上订房连接
        if(empty($assign_data['card_info']['shop_header_url'])&&empty($assign_data['card_info']['hotel_header_url'])&&empty($assign_data['card_info']['soma_header_url'])){
            $assign_data['card_info']['hotel_header_url']='/index.php/hotel/hotel/search?id='.$this->inter_id;
        }
        $this->template_show('member',$this->_template,'cardinfo',$assign_data);



    }

    //加密链接参数
    public function encrypt($inter_id,$open_id){
        $this->load->model('wx/Publics_model','publics_model');

        //加密参数
        $this->load->helper('qfglobal');
        $public = $this->publics_model->get_public_by_id ($this->inter_id);
        $key = $public['app_secret'];
        $ec_data = $inter_id.$open_id;
        $sign = kecrypt($ec_data,$key);   $this->load->model('wx/Publics_model','publics_model');
        return base64_encode($this->inter_id.'***'.$this->openid.'***'.$sign);
    }

    /**
     * 获取微信JSSDK配置信息
     * @param $inter_id
     * @param string $url
     * @return array
     */
    protected function _get_sign_package($inter_id, $url=''){
        $this->load->helper('common');
        $this->load->model('wx/publics_model', 'publics');
        $this->load->model('wx/access_token_model');
        $jsapiTicket = $this->access_token_model->get_api_ticket( $inter_id );

        $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off'
            || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
        if(!$url)
            $url = "$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";

        $timestamp = time();
        $nonceStr = createNonceStr();
        $public = $this->publics->get_public_by_id( $inter_id );

        // 这里参数的顺序要按照 key 值 ASCII 码升序排序
        $string = "jsapi_ticket=$jsapiTicket&noncestr=$nonceStr&timestamp=$timestamp&url=$url";
        $signature = sha1($string);
        $signPackage = array(
            "appId"     => $public['app_id'],
            "nonceStr"  => $nonceStr,
            "timestamp" => $timestamp,
            "url"       => $url,
            "signature" => $signature,
            "rawString" => $string
        );
        return $signPackage;
    }


}
?>