<?php
use App\services\member\CenterService;
// +----------------------------------------------------------------------
// | 会员中心
// +----------------------------------------------------------------------
// | copyright: http://www.iwide.cn
// +----------------------------------------------------------------------
// | Author: liwensong <septet-l@outlook.com>
// +----------------------------------------------------------------------
// | version 4.0
// +----------------------------------------------------------------------
// | Center.php 2017-07-12
// +----------------------------------------------------------------------
defined('BASEPATH') OR exit('No direct script access allowed');

/**
 * Class Center
 * @property Member_model $mem
 * @property Member_model $m_model
 * @property CI_Input  $input
 * @property CI_Loader $load
 */
class Center extends MY_Front_Member_Iapi
{
    private   $extra = array();
    protected $args = array();
    private   $client_ip = '';
    public function __construct()
    {
        parent::__construct();
        $this->load->library("MYLOG");
        $this->load->helper('common_helper');
        $this->extra['links'] = array(
            'wx_login' => EA_const_url::inst()->get_url('membervip/login/index',array('inter_id'=>$this->inter_id)),
            'login' => EA_const_url::inst()->get_url('membervip/login/index',array('inter_id'=>$this->inter_id)),
            'reg' => EA_const_url::inst()->get_url('membervip/reg/index',array('inter_id'=>$this->inter_id)),
            'perfectinfo'=>EA_const_url::inst()->get_url('membervip/perfectinfo',array('inter_id'=>$this->inter_id))
        );

        $this->args = get_args();
        $this->client_ip = $this->input->ip_address();
        MYLOG::w(@json_encode(array('args' => $this->args, 'client_ip' => $this->client_ip)), 'iapi/front/membervip/debug-log', 'center-call');
    }


    //会员卡用户中心
    public function member_center(){
        $this->extra['links']['shop'] = EA_const_url::inst()->get_url('soma/order/my_order_list',array('inter_id'=>$this->inter_id));
        $this->extra['links']['hotel'] = EA_const_url::inst()->get_url('hotel/hotel/myorder',array('inter_id'=>$this->inter_id));
        $member_center_result = CenterService::getInstance()->member_center($this->inter_id,$this->openid,$this->_template_filed_names);
        $this->out_put_msg($member_center_result['status'],$member_center_result['msg'],$member_center_result['data'],'membervip/center/member_center',$this->extra);
    }

	//会员卡用户资料
	public function info(){
        $this->extra['links']['outlogin'] = EA_const_url::inst()->get_url('membervip/login/outlogin',array('inter_id'=>$this->inter_id));
        $member_info = CenterService::getInstance()->info($this->inter_id,$this->openid);
        $this->sp_out_put_msg('countent',$member_info['data'],'membervip/center/info',$this->extra);
    }

    //储值卡二维码页面
    public function qrcode(){
        $data['centerinfo'] = array();
        $post_center_url = PMS_PATH_URL."member/center";
        $post_center_data =  array(
            'inter_id'=>$this->inter_id,
            'openid' =>$this->openid,
        );
        //请求用户登录(默认)会员卡信息
        $centerinfo = $this->doCurlPostRequest($post_center_url,$post_center_data);
        if(isset($centerinfo['data']) && !empty($centerinfo['data'])){
            $data['centerinfo'] = $centerinfo['data'];
        }
        $this->template_show('member',$this->_template,'qrcode',$data);
    }

public function remote(){
        if($this->inter_id!='a449675133'){
            $this->index();
            exit;
        }
        //获取appID
          $this->load->library ("MYLOG");
          $appid=$this->db->query('SELECT * FROM `iwide_publics` WHERE `inter_id` LIKE \'a449675133\'')->result_array()['0']['app_id'];
        $post_center_url = PMS_PATH_URL."member/center";
        $post_center_data =  array(
            'inter_id'=>$this->inter_id,
            'openid' =>$this->openid,
        );
        //请求用户登录(默认)会员卡信息(注：第一次有可能返回的数据是空)
        $center_data = $this->doCurlPostRequest( $post_center_url , $post_center_data );
        if(!empty($center_data['data']['membership_number'])){
            $url='http://mts.xiezhuwang.com/hotelmaster/firstLookV2?appID='.$appid.'&memberKey='.$center_data['data']['membership_number'];
            header("Location:".$url);
            exit;
        }else {
            $this->index();
            exit;
        }
    }
    
    public function qrcodecon(){
        $this->load->helper ('phpqrcode');
        $url = urldecode($_GET["data"]);
        $margin = isset($_GET['margin']) ? $_GET['margin']:10;
        QRcode::png($url,false,'Q',30,$margin,true);
    }

    public function soma(){
        $this->load->model('membervip/front/Member_model','mem');
        $user = $this->mem->get_user_info($this->inter_id,$this->openid,'member_mode,is_login');
        if(empty($user) || $user['member_mode']=='1' || $user['is_login']=='f'){
            redirect('membervip/login').'?id='.$this->inter_id;
        }elseif ($user['is_login']=='t'){
            redirect('http://junting.hfmc99.com/index.php/soma/package/index').'?id='.$this->inter_id;
        }
        redirect(site_url('membervip/center').'?id='.$this->inter_id);
    }

    public function bgywechat(){
        $this->load->model('membervip/front/Member_model','m_model');
        $this->load->library("MYLOG");
        $user = $this->m_model->get_user_info($this->inter_id,$this->openid);
        MYLOG::w(json_encode(array('res'=>$user)),'front/membervip/center','bgywechat');
        if(empty($user)) redirect(site_url('membervip/center').'?id='.$this->inter_id);
        if($user['member_mode']==1) redirect(site_url('membervip/login').'?id='.$this->inter_id);
        $jumpurl = "http://h5.bgyhotel.com:9090/m/h5/wechat?icNum={$user['membership_number']}&mobile={$user['telephone']}&openId={$user['open_id']}";
        MYLOG::w(json_encode(array('jumpurl'=>$jumpurl)),'front/membervip/center','bgywechat');
        redirect($jumpurl);
    }
	
	
	public function showopenid(){
		
		
		echo $this->openid;
	}
}
?>