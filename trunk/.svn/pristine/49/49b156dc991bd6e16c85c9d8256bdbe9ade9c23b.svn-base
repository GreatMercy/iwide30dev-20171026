<template>
</template>
<script>
  import { millsecondsToDHMS } from '../../utils/utils'
  export default {
    name: 'kill-clock',
    data () {
      return {
        process: 1,
        dates: 0,
        hours: 0,
        minutes: 0,
        seconds: 0
      }
    },
    created () {
      let that = this
      let reminders
      if (that.startTimeNodeReminder) {
        reminders = that.startTimeNodeReminder.concat()
      }
      that.interval = setInterval(function () {
        let now = Date.now()
        let gap1 = now - that.start
        let gap2 = that.end - now
        if (gap1 < 0) {
          that.process = 1
          let dhms = millsecondsToDHMS(gap1)
          that.dates = dhms.dates
          that.hours = dhms.hours
          that.minutes = dhms.minutes
          that.seconds = dhms.seconds
          if (reminders) {
            let index = reminders.indexOf(-gap1)
            if (index > -1) {
              that.$emit('on-start-time-node-reminder', reminders[index], 1)
              reminders.splice(index, 1)
            } else {
              let len = reminders.length
              let i = 0
              while (i < len) {
                if (reminders[i] > -gap1) {
                  that.$emit('on-start-time-node-reminder', reminders[i], 0)
                  reminders.splice(i, 1)
                  break
                }
                i++
              }
            }
          }
          that.$emit('has-start', now)
        } else if (gap2 > 0 || gap1 === 0) {
          if (gap1 === 0) {
            that.$emit('on-start', now)
          }
          that.process = 2
          let dhms = millsecondsToDHMS(gap2)
          that.dates = dhms.dates
          that.hours = dhms.hours
          that.minutes = dhms.minutes
          that.seconds = dhms.seconds
        } else {
          if (gap2 === 0) {
            that.$emit('on-finish', now)
          } else {
            that.$emit('has-finish', now)
          }
          that.process = 0
          clearInterval(that.interval)
        }
      }, that.delay)
    },
    props: {
      start: {
        type: Number,
        required: true
      },
      end: {
        type: Number,
        required: true
      },
      'startTimeNodeReminder': {
        type: Array
      },
      delay: {
        type: Number,
        default: 1000
      }
    }
  }
</script>