<?php
defined('BASEPATH') OR exit('No direct script access allowed');
/**
*	用户重置密码
*	@author  Ljp
*	@copyright www.iwide.cn
*	@version 4.0
*	@Email 401952599@qq.com
*/
class Resetpassword extends MY_Front_Member_Iapi
{
	//用户重置密码页面
	public function index(){
		$post_config_url = PMS_PATH_URL."adminmember/getresetconfig";
		$post_config_data =  array(
			'inter_id'=>$this->inter_id,
			);
		//请求注册配置
		$data['login_config'] = $this->doCurlPostRequest( $post_config_url , $post_config_data )['data'];
        $ext['links']['saveresetpassword'] = site_url('iapi/membervip/perfectinfo/saveresetpassword');
        $this->out_put_msg(1,'',$data,'membervip/resetpassword/index',$ext);

    }

	//保存重置密码
	public function saveresetpassword(){
		$post_login_url = PMS_PATH_URL."member/resetpassword";
		$post_login_data = array(
			'inter_id'=>$this->inter_id,
			'openid'=>$this->openid,
			'phone'=>$this->input->post('phone'),
			'data'=>$this->input->post(),
			'sms'=>$this->input->post('phonesms'),
        );

        //如果有验证码,验证
        $conf_url = PMS_PATH_URL."adminmember/getresetconfig";
        $post_data =  array('inter_id'=>$this->inter_id);
        //请求登录配置
        $pwdconfig = $this->doCurlPostRequest($conf_url,$post_data);
        $pwdconfig = isset($pwdconfig['data'])?$pwdconfig['data']:array();
        if(isset($pwdconfig['phonesms']) && $pwdconfig['phonesms']['show']=='1' && $pwdconfig['phonesms']['check']=='1'){
            if(!isset($_POST['phonesms'])) {
                $this->out_put_msg(3,'验证码不存在','','membervip/resetpassword/saveresetpassword');
            }
            $checkSmsData = $post_login_data;
            $checkSmsData['data']['sms']=$_POST['phonesms'];
            $checkSmsData['cellphone']=$post_login_data['phone'];
            $checkSmsData['smstype'] = isset($_POST['smstype'])?$_POST['smstype']:0;
            $res = $this->doCurlPostRequest(PMS_PATH_URL."member/checksms",$checkSmsData);
            if($res['err']>0){
                $this->out_put_msg(3,$res['msg'],'','membervip/resetpassword/saveresetpassword');

            }
        }

		$login_result = $this->doCurlPostRequest( $post_login_url , $post_login_data );
        $login_result = $this->parse_curl_msg($login_result);
        if($login_result['code']==1){
            $ext['links']['next'] = site_url('membervip/login');
            $this->out_put_msg(1,$login_result['msg'],$login_result['data'],'membervip/resetpassword/saveresetpassword',$ext);
        }else{
            $this->out_put_msg(3,$login_result['msg'],$login_result['data'],'membervip/resetpassword/saveresetpassword');
        }
	}

    //储值卡重置密码页面
    public function resetbindpwd(){
        $post_config_url = PMS_PATH_URL."adminmember/getresetconfig";
        $post_config_data =  array(
            'inter_id'=>$this->inter_id,
        );
        //请求注册配置
        $data['login_config'] = $this->doCurlPostRequest( $post_config_url , $post_config_data )['data'];
        $ext['links']['saveresetbindpwd'] = site_url('iapi/membervip/perfectinfo/saveresetbindpwd');
        $this->out_put_msg(1,'',$data,'membervip/resetpassword/resetbindpwd',$ext);

    }

    //保存重置密码
    public function saveresetbindpwd(){
        $post_login_url = PMS_PATH_URL."member/resetpassword";
        $post_login_data = array(
            'inter_id'=>$this->inter_id,
            'openid'=>$this->openid,
            'phone'=>$this->input->post('phone'),
            'data'=>$this->input->post(),
            'pandc'=>1
        );

        $login_result = $this->doCurlPostRequest( $post_login_url , $post_login_data );
        $login_result = $this->parse_curl_msg($login_result);
        if($login_result['code']==1){
            $ext['links']['next'] = site_url('membervip/login');
            $this->out_put_msg(1,$login_result['msg'],$login_result['data'],'membervip/resetpassword/saveresetbindpwd',$ext);
        }else{
            $this->out_put_msg(3,$login_result['msg'],$login_result['data'],'membervip/resetpassword/saveresetbindpwd');
        }
    }
}
?>